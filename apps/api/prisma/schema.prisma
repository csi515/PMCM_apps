generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------------------------
// SYS Plugin (System & Auth)
// ------------------------------------------------------

enum Role {
  USER
  MANAGER
  ADMIN
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique // Employee ID
  password  String
  name      String
  deptCode  String
  birthDate String?  // For initial password reset logic
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  gtmTasks  GtmTask[] @relation("Assignee")
  gtmWeeklyReports GtmWeeklyReport[]
  rndLogs   RndEquipmentUsageLog[]
  rndHazardousLogs RndHazardousLog[]
  rndAnalysisRequests RndAnalysisRequest[]
  managedEquipments RndEquipment[] @relation("EquipmentManager")
  managedSafetyDocs RndSafetyDoc[]

  @@map("SYS_Users")
}

// ------------------------------------------------------
// GTM Plugin (General Task Management)
// ------------------------------------------------------

model GtmStrategicGoal {
  id          String   @id @default(uuid()) @map("goal_id")
  title       String
  titleJa     String?  @map("title_ja")
  year        Int
  category    String
  targetValue Decimal  @map("target_value") @db.Decimal(10, 2)
  currentValue Decimal @default(0) @map("current_value") @db.Decimal(10, 2)
  
  // Standard Audit Fields
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")
  createdBy   Int?     @map("created_by") // Should ideally be UUID if User ID becomes UUID, currently Int in SYS
  updatedBy   Int?     @map("updated_by")
  isDeleted   Boolean  @default(false) @map("is_deleted")

  projects    GtmProject[]

  @@map("GTM_STRATEGIC_GOALS")
}

model GtmProject {
  id            String   @id @default(uuid()) @map("project_id")
  deptId        String   @map("dept_id") // Core FK
  goalId        String   @map("goal_id")
  projectName   String   @map("project_name")
  projectNameJa String?  @map("project_name_ja")
  description   String?
  descriptionJa String?  @map("description_ja")
  status        String   
  startDate     DateTime @map("start_date")
  endDate       DateTime @map("end_date")
  baselineStart DateTime @map("baseline_start")
  baselineEnd   DateTime @map("baseline_end")
  isPrivate     Boolean  @default(false) @map("is_private")

  // Standard Audit Fields
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")
  createdBy   Int?     @map("created_by")
  updatedBy   Int?     @map("updated_by")
  isDeleted   Boolean  @default(false) @map("is_deleted")
  
  goal        GtmStrategicGoal @relation(fields: [goalId], references: [id])
  tasks       GtmTask[]

  @@map("GTM_PROJECTS")
}

model GtmTask {
  id            String   @id @default(uuid()) @map("task_id")
  projectId     String   @map("project_id")
  deptId        String   @map("dept_id")
  parentTaskId  String?  @map("parent_task_id")
  assigneeId    Int?     @map("assignee_id") // User is Int
  taskName      String   @map("task_name")
  taskNameJa    String?  @map("task_name_ja")
  progress      Decimal  @default(0) @db.Decimal(5, 2)
  weight        Decimal  @default(1) @db.Decimal(5, 2)
  dependencyIds Json?    @map("dependency_ids") // JSONB
  status        String 
  startDate     DateTime @map("start_date")
  endDate       DateTime @map("end_date")

  // Standard Audit Fields
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")
  createdBy   Int?     @map("created_by")
  updatedBy   Int?     @map("updated_by")
  isDeleted   Boolean  @default(false) @map("is_deleted")
  
  project       GtmProject @relation(fields: [projectId], references: [id])
  parentTask    GtmTask?   @relation("SubTasks", fields: [parentTaskId], references: [id])
  subTasks      GtmTask[]  @relation("SubTasks")
  assignee      User?      @relation("Assignee", fields: [assigneeId], references: [id])
  attachments   GtmTaskAttachment[]

  @@map("GTM_TASKS")
}

model GtmWeeklyReport {
  id            String   @id @default(uuid()) @map("report_id")
  userId        Int      @map("user_id")
  deptId        String   @map("dept_id")
  year          Int
  weekNumber    Int      @map("week_number")
  achievements  String?  @db.Text
  achievementsJa String? @map("achievements_ja") @db.Text
  plans         String?  @db.Text
  plansJa       String?  @map("plans_ja") @db.Text
  issues        String?  @db.Text
  issuesJa      String?  @map("issues_ja") @db.Text
  status        String   @default("DRAFT")
  mgrComment    String?  @map("mgr_comment") @db.Text

  // Standard Audit Fields
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")
  createdBy   Int?     @map("created_by")
  updatedBy   Int?     @map("updated_by")
  isDeleted   Boolean  @default(false) @map("is_deleted")

  user        User     @relation(fields: [userId], references: [id])

  @@map("GTM_WEEKLY_REPORTS")
}

model GtmTaskAttachment {
  id          String   @id @default(uuid()) @map("attach_id")
  taskId      String   @map("task_id")
  ecmLink     String   @map("ecm_link")
  fileName    String   @map("file_name")
  fileSize    BigInt   @map("file_size")

  // Standard Audit Fields
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")
  createdBy   Int?     @map("created_by")
  updatedBy   Int?     @map("updated_by")
  isDeleted   Boolean  @default(false) @map("is_deleted")

  task        GtmTask  @relation(fields: [taskId], references: [id])

  @@map("GTM_TASK_ATTACHMENTS")
}

// ------------------------------------------------------
// QMS Plugin (Quality Management System)
// ------------------------------------------------------

model QmsIssue {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  status      String   @default("OPEN")
  pdcaStep    String   @default("PLAN") // PLAN, DO, CHECK, ACT
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("QMS_Issues")
}

// ------------------------------------------------------
// RND Plugin (Research & Development)
// ------------------------------------------------------

model RndEquipment {
  id          Int      @id @default(autoincrement())
  assetNumber String?  @unique @map("asset_number")
  name        String
  modelName   String?  @map("model_name")
  manufacturer String?
  location    String?
  managerId   Int?     @map("manager_id")
  manualUrl   String?  @map("manual_url")
  status      String   @default("AVAILABLE") // AVAILABLE, IN_USE, MAINTENANCE, RESERVED
  
  lastCalibrationDate DateTime? @map("last_calibration_date")
  nextCalibrationDate DateTime? @map("next_calibration_date")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")
  
  logs        RndEquipmentUsageLog[]
  manager     User?    @relation("EquipmentManager", fields: [managerId], references: [id])

  @@map("RND_Equipments")
}

model RndEquipmentUsageLog {
  id          Int      @id @default(autoincrement())
  equipmentId Int
  userId      Int
  startTime   DateTime // Reservation start
  endTime     DateTime? // Reservation end
  actualStart DateTime?
  actualEnd   DateTime?
  note        String?

  equipment   RndEquipment @relation(fields: [equipmentId], references: [id])
  user        User         @relation(fields: [userId], references: [id])

  @@map("RND_EquipmentUsageLogs")
}

model RndInventory {
  id          Int      @id @default(autoincrement())
  name        String
  casNo       String?  @map("cas_no")
  location    String?
  safetyStock Decimal  @default(0) @map("safety_stock") @db.Decimal(10, 4)
  currentStock Decimal @default(0) @map("current_stock") @db.Decimal(10, 4)
  unit        String   @default("EA")
  isHazardous Boolean  @default(false) @map("is_hazardous")
  msdsUrl     String?  @map("msds_url")
  
  logs        RndInventoryLog[]
  hazardousLogs RndHazardousLog[]

  @@map("RND_Inventories")
}

model RndInventoryLog {
  id          Int      @id @default(autoincrement())
  inventoryId Int
  type        String   // IN, OUT
  amount      Float
  createdAt   DateTime @default(now())

  inventory   RndInventory @relation(fields: [inventoryId], references: [id])

  @@map("RND_InventoryLogs")
}

model RndSafetyDoc {
  id            Int      @id @default(autoincrement())
  title         String
  docType       String   // RISK_ASSESSMENT, WORK_STANDARD
  fileUrl       String?
  lastUpdated   DateTime
  nextUpdateDue DateTime
  
  department    String?
  managerId     Int?
  sopVersion    String?
  
  manager       User?    @relation(fields: [managerId], references: [id])

  @@map("RND_SafetyDocs")
}

model RndProject {
  id              String   @id @default(uuid()) @map("project_id")
  name            String
  type            String   // GENERAL, NATIONAL
  status          String   // PLANNED, ACTIVE, COMPLETED, ON_HOLD, DROPPED
  
  // Charter Fields
  background      String?  @db.Text
  problemStatement String? @map("problem_statement") @db.Text
  objectives      String?  @db.Text
  methodology     String?  @db.Text
  expectedEffects String?  @map("expected_effects") @db.Text
  
  // Management Fields
  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")
  budget          Decimal  @default(0) @db.Decimal(15, 2)
  healthStatus    String   @default("GREEN") // RED, YELLOW, GREEN
  
  // Standard Audit Fields
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt      @map("updated_at")
  createdBy       Int?     @map("created_by")
  updatedBy       Int?     @map("updated_by")
  isDeleted       Boolean  @default(false) @map("is_deleted")

  compliance      RndComplianceChecklist[]
  analysisRequests RndAnalysisRequest[]

  @@map("RND_PROJECTS")
}

model RndHazardousLog {
  id              Int      @id @default(autoincrement())
  inventoryId     Int      @map("inventory_id")
  userId          Int      @map("user_id")
  usageDate       DateTime @map("usage_date")
  processName     String   @map("process_name")
  place           String?
  amountUsed      Decimal  @map("amount_used") @db.Decimal(10, 4)
  currentStock    Decimal  @map("current_stock") @db.Decimal(10, 4)
  ventilationOn   Boolean  @default(false) @map("ventilation_on")
  ppeChecked      Boolean  @default(false) @map("ppe_checked")
  signature       String?  // Digital signature string or ID

  createdAt       DateTime @default(now()) @map("created_at")

  inventory       RndInventory @relation(fields: [inventoryId], references: [id])
  user            User         @relation(fields: [userId], references: [id])

  @@map("RND_HAZARDOUS_LOGS")
}

model RndIP {
  id              Int      @id @default(autoincrement())
  managementNo    String   @unique @map("management_no")
  title           String
  type            String   // PATENT, PAPER, SW, IDEA
  status          String   // IDEA, FILED, REGISTERED, REJECTED, ABANDONED
  
  applicationNo   String?  @map("application_no")
  applicationDate DateTime? @map("application_date")
  registrationNo  String?  @map("registration_no")
  registrationDate DateTime? @map("registration_date")
  
  inventors       Json?    // Array of { name, share }
  rewardInfo      Json?    @map("reward_info")
  documents       Json?    // ECM Links
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt      @map("updated_at")

  @@map("RND_IP")
}

model RndComplianceChecklist {
  id              Int      @id @default(autoincrement())
  projectId       String   @map("project_id")
  stage           String   // INITIATION, EXECUTION, CLOSING
  itemName        String   @map("item_name")
  isRequired      Boolean  @default(true) @map("is_required")
  isSubmitted     Boolean  @default(false) @map("is_submitted")
  ecmLink         String?  @map("ecm_link")
  submittedDate   DateTime? @map("submitted_date")
  
  project         RndProject @relation(fields: [projectId], references: [id])

  @@map("RND_COMPLIANCE_CHECKLIST")
}

model RndAnalysisRequest {
  id              Int      @id @default(autoincrement())
  projectId       String?  @map("project_id")
  requesterId     Int      @map("requester_id")
  sampleName      String   @map("sample_name")
  analysisType    String   @map("analysis_type")
  desiredDate     DateTime? @map("desired_date")
  status          String   @default("REQUESTED") // REQUESTED, PROCESSING, COMPLETED
  resultReportLink String? @map("result_report_link")
  rawDataLink     String?  @map("raw_data_link")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt      @map("updated_at")

  project         RndProject? @relation(fields: [projectId], references: [id])
  requester       User        @relation(fields: [requesterId], references: [id])

  @@map("RND_ANALYSIS_REQUESTS")
}

// ------------------------------------------------------
// QMS Plugin (Quality Management System)
// ------------------------------------------------------

model QmsVoc {
  id            Int      @id @default(autoincrement())
  vocNo         String   @unique @map("voc_no") // VOC-YYYY-MM-NNN
  title         String
  description   String?  @db.Text
  type          String   // COMPLAINT, INQUIRY, SUGGESTION
  customer      String
  product       String?
  status        String   @default("RECEIVED") // RECEIVED, ANALYZING, ACTION, VERIFIED, CLOSED
  
  // Relations
  qualityIssues QmsQualityIssue[]

  // Audit
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")
  createdBy     Int?     @map("created_by")
  updatedBy     Int?     @map("updated_by")
  isDeleted     Boolean  @default(false) @map("is_deleted")

  @@map("QMS_VOC")
}

model QmsQualityIssue {
  id            Int      @id @default(autoincrement())
  issueNo       String   @unique @map("issue_no")
  title         String
  description   String?  @db.Text
  status        String   @default("OPEN")
  processStep   String   @default("D0") @map("process_step") // D0..D8
  
  // Links
  vocId         Int?     @map("voc_id")
  voc           QmsVoc?  @relation(fields: [vocId], references: [id])

  // 8D Report Fields (simplified for schema, can be JSON or separate tables if complex)
  d0Containment String?  @map("d0_containment") @db.Text
  d1Team        Json?    @map("d1_team") // Array of User IDs
  d2Problem     String?  @map("d2_problem") @db.Text
  d3Interim     String?  @map("d3_interim") @db.Text
  d4RootCause   String?  @map("d4_root_cause") @db.Text
  d5Corrective  String?  @map("d5_corrective") @db.Text
  d6Implement   String?  @map("d6_implement") @db.Text
  d7Prevent     String?  @map("d7_prevent") @db.Text
  d8Congrat     String?  @map("d8_congrat") @db.Text

  // Audit
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")
  createdBy     Int?     @map("created_by")
  updatedBy     Int?     @map("updated_by")
  isDeleted     Boolean  @default(false) @map("is_deleted")

  @@map("QMS_QUALITY_ISSUES")
}

model QmsFmea {
  id            Int      @id @default(autoincrement())
  fmeaNo        String   @unique @map("fmea_no")
  title         String
  partName      String?  @map("part_name")
  partNumber    String?  @map("part_number")
  revision      String   @default("1")
  
  items         QmsFmeaItem[]

  // Audit
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")
  createdBy     Int?     @map("created_by")
  updatedBy     Int?     @map("updated_by")
  isDeleted     Boolean  @default(false) @map("is_deleted")

  @@map("QMS_FMEA")
}

model QmsFmeaItem {
  id            Int      @id @default(autoincrement())
  fmeaId        Int      @map("fmea_id")
  processFunction String @map("process_function")
  failureMode   String   @map("failure_mode")
  effect        String
  cause         String
  
  severity      Int
  occurrence    Int
  detection     Int
  rpn           Int      // Calculated

  recommendation String?
  
  fmea          QmsFmea  @relation(fields: [fmeaId], references: [id])
  
  @@map("QMS_FMEA_ITEMS")
}

model QmsPpap {
  id            Int      @id @default(autoincrement())
  title         String
  customer      String
  submissionLevel Int    @map("submission_level") // 1..5
  status        String   @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED
  
  documents     QmsPpapDocument[]

  // Audit
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")
  createdBy     Int?     @map("created_by")
  updatedBy     Int?     @map("updated_by")
  isDeleted     Boolean  @default(false) @map("is_deleted")

  @@map("QMS_PPAP")
}

model QmsPpapDocument {
  id            Int      @id @default(autoincrement())
  ppapId        Int      @map("ppap_id")
  docType       String   @map("doc_type") // PSW, FMEA, CP, DRAWING
  fileUrl       String   @map("file_url")
  status        String   @default("PENDING")

  ppap          QmsPpap  @relation(fields: [ppapId], references: [id])

  @@map("QMS_PPAP_DOCUMENTS")
}

model QmsStandardLibrary {
  id            Int      @id @default(autoincrement())
  category      String   // FAILURE_MODE, CAUSE, EFFECT, CONTROL
  code          String   @unique
  name          String
  nameJa        String?  @map("name_ja")
  description   String?

  @@map("QMS_STANDARD_LIBRARY")
}

model QmsSpcChart {
  id            Int      @id @default(autoincrement())
  code          String   @unique
  title         String
  nominal       Float?
  usl           Float?   @map("usl")
  lsl           Float?   @map("lsl")
  ucl           Float?   @map("ucl") // Calculated Control Limit (optional storage)
  lcl           Float?   @map("lcl") // Calculated Control Limit (optional storage)
  
  dataPoints    QmsSpcData[]

  // Audit
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")

  @@map("QMS_SPC_CHARTS")
}

model QmsSpcData {
  id            Int      @id @default(autoincrement())
  chartId       Int      @map("chart_id")
  value         Float
  measuredAt    DateTime @default(now()) @map("measured_at")
  
  chart         QmsSpcChart @relation(fields: [chartId], references: [id])

  @@map("QMS_SPC_DATA")
}

model QmsNotification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  title     String
  message   String
  type      String   // info, warning, error, success
  isRead    Boolean  @default(false) @map("is_read")
  relatedEntityId   Int?     @map("related_entity_id") // ID of the related object (e.g., Issue ID)
  relatedEntityType String?  @map("related_entity_type") // e.g., 'ISSUE', 'PPAP'

  createdAt DateTime @default(now()) @map("created_at")

  @@map("QMS_NOTIFICATIONS")
}

model QmsAuditLog {
  id        Int      @id @default(autoincrement())
  entityId    String   @map("entity_id") // ID as string to be generic
  entityType  String   @map("entity_type") // e.g. 'ISSUE', 'PPAP'
  action      String   // CREATE, UPDATE, DELETE, APPROVE
  userId      Int      @map("user_id") 
  details     Json?    // Changed fields or snapshot
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("QMS_AUDIT_LOGS")
}
